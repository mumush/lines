<script>

window.onload = function(challengeUser) {

   console.log('In app.ejs');

   // **** Get Client Cookies Sent From Server ****

   var cookieToken = docCookies.getItem('linesApp');
   var cookieUsername = docCookies.getItem('linesAppUser');

   console.log('Client Token: ' + cookieToken);
   console.log('Client Username: ' + cookieUsername);

   // **** Initialize Socket IO ****

   var socket = io(); // Default to connect to host that serves page


   // **** Initialize Online Users & Chat ****

   var onlineUsers = <%- JSON.stringify(users) %>; // 'users' passed in via EJS

   initOnlineUsers(onlineUsers);
   initChat();


   // **** Start Socket IO Events ****

   // Immediately emit that user is online
   socket.emit('go online', {username: cookieUsername});

   // When a new user goes online
   socket.on('user online', function(username) {
      addOnlineUser(username);
      console.log(username + ' is online.');
   });

   // When a new user goes online
   socket.on('user offline', function(username) {
      removeOnlineUser(username);
      console.log(username + ' went offline.');
   });


   // **** DOM Methods ****

   function initOnlineUsers(users) {
      for( var i=0; i<users.length; i++ ) {
         addOnlineUser(users[i].username);
      }
   }

   function initChat() {
      $('#compose-message-form').on('submit', function(){ sendMessage(event) });
   }

   function addOnlineUser(username) {

      var newUserItem = $('<li>');
      newUserItem.addClass('online-user');
      newUserItem.attr('id', ('user-' + username));
      newUserItem.text(username);

      var challengeUserBut = $('<button>');
      challengeUserBut.on('click', function(){ challengeUser(username); });
      challengeUserBut.text('Challenge');

      newUserItem.append(challengeUserBut);

      $('#online-users-list').prepend(newUserItem);
   }

   function removeOnlineUser(username) {
      var attrSelector = "#user-" + username;
      var userListItem = $(attrSelector);
      userListItem.remove();
   }


   // **** Onclick/Onsubmit Methods ****

   function challengeUser(username) {
      console.log('Challenge User: ' + username);
   }

   function sendMessage(event) {
      event.preventDefault();
      var message = $('#message-input').val();
      console.log('Send Message: ' + message);
   }



};

</script>
